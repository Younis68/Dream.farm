<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0f2e20">
    
    <title data-i18n="pageTitle">Dream Farm | باشترین مزارع بۆ بەکرێگرتن</title>
    <link rel="icon" href="https://img.icons8.com/emoji/48/crown-emoji.png" type="image/png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;500;700;800&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_green.css">

    <style>
        /* --- CSS Variables --- */
        :root { 
            --primary-gold: #D4AF37; 
            --primary-dark: #0f2e20; 
            --bg-body: #f4f7f6; 
            --bg-card: #ffffff;
            --text-main: #1a1a1a;
            --text-sec: #555555;
            --border-color: #eeeeee;
            --input-bg: #ffffff;
            --badge-bg: #f4f7f6;
            --shadow-color: rgba(0,0,0,0.08);
            --radius-lg: 24px; 
            --font-ar: 'Noto Sans Arabic', sans-serif;
            --font-en: 'Poppins', sans-serif;
            --font-main: var(--font-ar);
        }

        [data-theme="dark"] {
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sec: #aaaaaa;
            --border-color: #333333;
            --input-bg: #2c2c2c;
            --badge-bg: #2c2c2c;
            --shadow-color: rgba(0,0,0,0.5);
        }

        html[dir="ltr"] { --font-main: var(--font-en); }
        html[dir="ltr"] .search-input-group i { margin-left: 0; margin-right: 10px; }
        html[dir="ltr"] .date-input-group i { margin-left: 0; margin-right: 8px; }
        html[dir="ltr"] .date-input-group .clear-date { left: auto; right: 5px; }
        html[dir="ltr"] .card-title-row h3 { flex-direction: row-reverse; justify-content: flex-end; }
        
        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; letter-spacing: normal !important; }
        body { font-family: var(--font-main); background-color: var(--bg-body); color: var(--text-main); overflow-x: hidden; display: flex; flex-direction: column; min-height: 10vh; transition: background-color 0.3s, color 0.3s; }
        
        /* --- Flag Images Style (FIXED) --- */
        .flag-img { 
            width: 36px;       /* Width of the flag */
            height: 24px;      /* Height of the flag */
            border-radius: 4px; 
            object-fit: fill;  /* Ensures the whole flag shows */
            border: 1px solid #ccc; 
            vertical-align: middle; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .lang-label { display: flex; align-items: center; gap: 12px; font-size: 1.1rem; }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(211, 47, 47, 0); }
            100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); }
        }
        .urgency-badge {
            display: inline-flex; align-items: center; gap: 6px;
            background: rgba(255, 235, 238, 0.9); color: #c62828;
            padding: 6px 12px; border-radius: 20px; font-size: 0.8rem;
            font-weight: 700; margin-top: 8px; margin-bottom: 5px; width: fit-content;
            animation: pulse-red 2s infinite; border: 1px solid rgba(211, 47, 47, 0.2);
        }

        .amenities-list { margin: 15px 0 20px; display: flex; flex-wrap: wrap; gap: 10px; }
        .amenity-chip { 
            background: var(--bg-body); padding: 10px 14px; border-radius: 16px; border: 1px solid var(--border-color); 
            display: flex; align-items: center; gap: 10px; font-size: 0.85rem; font-weight: 500;
            color: var(--text-main); transition: all 0.2s;
        }
        
        #toast-box { visibility: hidden; min-width: 280px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 10000; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 0.95rem; opacity: 0; transition: opacity 0.5s, bottom 0.5s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        #toast-box.show { visibility: visible; opacity: 1; bottom: 50px; }
        
        #loader { position: fixed; inset: 0; background: var(--primary-dark); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.5s ease; pointer-events: none; }
        .loader-icon { font-size: 3rem; color: var(--primary-gold); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        header { 
            background-image: linear-gradient(rgba(15, 46, 32, 0.6), rgba(26, 60, 48, 0.8)), url('dream.jpg'); 
            background-size: cover; background-position: center; background-color: var(--primary-dark);
            min-height: 380px; display: flex; flex-direction: column; justify-content: center; align-items: center; 
            text-align: center; border-bottom-left-radius: 40px; border-bottom-right-radius: 40px; 
            padding: 20px 20px 80px 20px; position: relative; 
        }

        [data-theme="dark"] header { background-image: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.9)), url('dream.jpg'); }
        header h1 { font-size: 2.8rem; color: white; margin: 10px 0; font-weight: 800; text-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .brand-badge { background: rgba(255,255,255,0.15); padding: 8px 20px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.3); color: var(--primary-gold); font-size: 0.9rem; font-weight: 700; backdrop-filter: blur(5px); }
        
        .header-btns { position: absolute; top: 25px; right: 25px; display: flex; gap: 10px; z-index: 100; }
        html[dir="ltr"] .header-btns { right: auto; left: 25px; }

        .icon-btn { background: rgba(255, 255, 255, 0.15); color: white; width: 45px; height: 45px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; border: 1px solid rgba(255,255,255,0.2); }
        .icon-btn:hover { background: rgba(255, 255, 255, 0.3); }

        .search-container { margin-top: -60px; padding: 0 20px; position: relative; z-index: 50; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .search-box-wrapper { background: var(--bg-card); width: 100%; max-width: 700px; padding: 5px; border-radius: 50px; display: flex; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid var(--border-color); }
        
        .search-input-group { flex: 1; display: flex; align-items: center; padding-right: 15px; border-left: 1px solid var(--border-color); }
        html[dir="ltr"] .search-input-group { padding-right: 0; padding-left: 15px; border-left: none; border-right: 1px solid var(--border-color); }
        .search-input-group input { width: 100%; border: none; font-size: 1rem; padding: 12px 0; font-family: inherit; color: var(--text-main); background: transparent; }
        
        .date-input-group { width: 140px; display: flex; align-items: center; padding: 0 15px; cursor: pointer; position: relative; }
        .date-input-group input { width: 100%; border: none; font-size: 0.9rem; padding: 12px 0; font-family: inherit; color: var(--text-sec); cursor: pointer; background: transparent; }
        .clear-date { position: absolute; left: 5px; color: #999; font-size: 0.8rem; cursor: pointer; display: none; }

        .filter-scroll { width: 100%; max-width: 800px; overflow-x: auto; padding-bottom: 10px; display: flex; gap: 10px; justify-content: flex-start; scrollbar-width: none; cursor: grab; }
        .filter-btn { white-space: nowrap; padding: 10px 20px; border-radius: 30px; border: 1px solid transparent; background: rgba(255,255,255,0.9); color: var(--primary-dark); font-family: inherit; font-weight: 600; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.05); font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
        .filter-btn.active { background: var(--primary-gold) !important; color: white !important; }
        [data-theme="dark"] .filter-btn { background: #2c2c2c; color: #e0e0e0; }

        .container { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 30px; max-width: 1200px; margin: 40px auto; padding: 0 20px; flex: 1; width: 100%; }
        
        .farm-card { 
            background: var(--bg-card); border-radius: var(--radius-lg); overflow: hidden; box-shadow: 0 15px 40px var(--shadow-color); 
            position: relative; display: flex; flex-direction: column; transition: transform 0.3s ease; border: 1px solid var(--border-color); opacity: 0; 
        }
        .farm-card.is-visible { animation: fadeInUp 0.5s ease forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .swiper { width: 100%; height: 260px; background: #eee; }
        .swiper-slide img { width: 100%; height: 100%; object-fit: cover; }
        
        .img-actions { position: absolute; top: 15px; left: 15px; z-index: 20; display: flex; flex-direction: column; gap: 10px; }
        html[dir="ltr"] .img-actions { left: auto; right: 15px; }

        .action-icon { width: 38px; height: 38px; background: rgba(255,255,255,0.9); backdrop-filter: blur(4px); color: var(--primary-dark); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: 0.2s; font-size: 1rem; }
        .action-icon.is-fav { color: #e91e63; background: white; }
        
        .expand-btn { position: absolute; bottom: 15px; right: 15px; width: 38px; height: 38px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 20; }
        html[dir="ltr"] .expand-btn { right: auto; left: 15px; }

        .card-content { padding: 25px; flex-grow: 1; display: flex; flex-direction: column; }
        .card-title-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
        .card-title-row h3 { font-size: 1.2rem; color: var(--text-main); display: flex; align-items: center; gap: 6px; }
        .verified-badge { color: #1da1f2; font-size: 1rem; }

        .location-text { font-size: 0.9rem; color: var(--text-sec); margin-bottom: 10px; display: flex; align-items: center; gap: 5px; margin-top: 10px; }
        
        .price-wrapper { margin-top: auto; padding-top: 15px; border-top: 1px dashed var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .price-val { font-size: 1.3rem; font-weight: 800; color: var(--primary-gold); }
        .book-btn { background: var(--primary-dark); color: white; border: none; padding: 12px 28px; border-radius: 14px; cursor: pointer; font-weight: 700; transition: 0.3s; box-shadow: 0 4px 15px rgba(15, 46, 32, 0.2); }
        [data-theme="dark"] .book-btn { background: var(--primary-gold); color: black; }

        /* Lightbox */
        .lightbox-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: none; justify-content: center; align-items: center; flex-direction: column; opacity: 0; transition: opacity 0.3s ease; }
        .lightbox-active { display: flex; opacity: 1; pointer-events: all; }
        .lightbox-img-container { position: relative; max-width: 90%; max-height: 80vh; }
        .lightbox-img { max-width: 100%; max-height: 80vh; border-radius: 8px; object-fit: contain; }
        .lb-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 2.5rem; cursor: pointer; z-index: 10001; }
        .lb-nav { position: absolute; top: 50%; transform: translateY(-50%); color: white; font-size: 2rem; cursor: pointer; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 50%; z-index: 10002; }
        .lb-prev { right: 20px; } .lb-next { left: 20px; }
        html[dir="ltr"] .lb-prev { right: auto; left: 20px; } html[dir="ltr"] .lb-next { left: auto; right: 20px; }
        
        /* Modals */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px); z-index: 2000; justify-content: center; align-items: center; padding: 20px; }
        .modal-box { background: var(--bg-card); width: 100%; max-width: 450px; border-radius: 24px; padding: 30px; position: relative; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.3); animation: slideUp 0.3s ease; color: var(--text-main); }
        .modal-active { display: flex; }
        .close-modal { position: absolute; left: 20px; top: 20px; font-size: 1.2rem; background: var(--badge-bg); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--text-sec); cursor: pointer; }
        html[dir="ltr"] .close-modal { left: auto; right: 20px; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-main); font-size: 0.9rem; }
        .form-group input, .form-group select { width: 100%; padding: 12px 15px; border: 2px solid var(--border-color); border-radius: 12px; font-family: inherit; font-size: 1rem; transition: 0.2s; background: var(--input-bg); color: var(--text-main); }
        .submit-wa { width: 100%; padding: 16px; border: none; border-radius: 12px; background: linear-gradient(135deg, #25D366, #128C7E); color: white; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1rem; margin-top: 10px; }
        
        .social-dock { position: fixed; bottom: 30px; left: 25px; display: flex; flex-direction: column-reverse; gap: 15px; z-index: 90; }
        html[dir="ltr"] .social-dock { left: auto; right: 25px; }
        .social-bubble { width: 48px; height: 48px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; box-shadow: 0 5px 20px rgba(0,0,0,0.25); text-decoration: none; transition: 0.3s transform; }
        .social-bubble:hover { transform: scale(1.1); }
        .wa { background: #25D366; } .tk { background: #000; } [data-theme="dark"] .tk { background: #fff; color: black; } .fb { background: #1877F2; } .in { background: radial-gradient(circle at 30% 107%, #fdf497 0%, #fd5949 45%, #d6249f 60%, #285AEB 90%); }
        
        #scrollTopBtn { position: fixed; bottom: 95px; left: 25px; width: 48px; height: 48px; background: var(--primary-dark); color: var(--primary-gold); border: 2px solid var(--primary-gold); border-radius: 50%; display: none; align-items: center; justify-content: center; cursor: pointer; z-index: 89; }
        html[dir="ltr"] #scrollTopBtn { left: auto; right: 25px; }

        footer { background-color: var(--primary-dark); color: white; padding: 50px 20px 30px; text-align: center; margin-top: 50px; border-top-left-radius: 40px; border-top-right-radius: 40px; position: relative; }
        [data-theme="dark"] footer { background-color: #000; }
        .footer-logo { font-size: 1.8rem; font-weight: 800; color: var(--primary-gold); display: block; margin-bottom: 10px; }
        .footer-links { display: flex; justify-content: center; gap: 20px; margin: 20px 0; font-size: 0.9rem; }
        .footer-links a { color: rgba(255,255,255,0.8); text-decoration: none; transition: 0.2s; }
        
        /* Language Modal */
        .lang-option { width: 100%; padding: 15px; border-radius: 12px; background: var(--bg-body); border: 1px solid var(--border-color); margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; font-weight: bold; transition: 0.2s; }
        .lang-option:hover, .lang-option.selected { border-color: var(--primary-gold); background: rgba(212, 175, 55, 0.1); }
        

        @media (max-width: 600px) { header { min-height: 320px; padding-bottom: 60px; } header h1 { font-size: 2.2rem; } .swiper { height: 220px; } .search-container { margin-top: -50px; } }
    </style>
</head>
<body>

    <div id="toast-box" data-i18n="copySuccess"><i class="fas fa-check-circle"></i> تم نسخ الرابط بنجاح</div>
    <div id="loader"><i class="fas fa-gem loader-icon"></i></div>

    <div id="lightbox" class="lightbox-overlay">
        <span class="lb-close" onclick="closeLightbox()">&times;</span>
        <div class="lb-nav lb-prev" onclick="changeImage(-1)"><i class="fas fa-chevron-right"></i></div>
        <div class="lb-nav lb-next" onclick="changeImage(1)"><i class="fas fa-chevron-left"></i></div>
        <div class="lightbox-img-container"><img id="lb-image" class="lightbox-img" src="" alt="Full View"></div>
        <div style="color:#ccc; margin-top:15px; font-family:sans-serif" id="lb-counter"></div>
    </div>

    <div id="lang-modal" class="modal-overlay">
        <div class="modal-box">
            <span class="close-modal" onclick="closeLangModal()">&times;</span>
            <h3 style="text-align:center; margin-bottom:20px;" data-i18n="selectLang">اختر اللغة</h3>
            
            <div class="lang-option" onclick="setLanguage('ar')">
                <span class="lang-label">
                    <img src="https://flagcdn.com/w40/iq.png" class="flag-img" alt="Iraq"> العربية
                </span>
                <i class="fas fa-check-circle" style="color:var(--primary-gold); display:none;" id="check-ar"></i>
            </div>
            
            <div class="lang-option" onclick="setLanguage('ku')">
                <span class="lang-label">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/5/55/Flag_of_Kurdistan.svg" class="flag-img" alt="Kurdistan"> 
                    کوردی (بادینی)
                </span>
                <i class="fas fa-check-circle" style="color:var(--primary-gold); display:none;" id="check-ku"></i>
            </div>
            
            <div class="lang-option" onclick="setLanguage('en')">
                <span class="lang-label">
                    <img src="https://flagcdn.com/w40/us.png" class="flag-img" alt="USA"> English
                </span>
                <i class="fas fa-check-circle" style="color:var(--primary-gold); display:none;" id="check-en"></i>
            </div>
        </div>
    </div>

    <div id="welcome-modal" class="modal-overlay" style="z-index:9500; display:flex; opacity:0; pointer-events:none; transition:0.5s;">
        <div class="modal-box" style="text-align:center; border:2px solid var(--primary-gold);">
            <i class="fas fa-crown" style="font-size:3.5rem; color:var(--primary-gold); margin-bottom:15px;"></i>
            <h2 style="margin-bottom:10px;" data-i18n="welcomeTitle">أهلاً بك في Dream Farm</h2>
            <p style="color:var(--text-sec);" data-i18n="welcomeSub">الوجهة الأولى للمزارع الراقية في العراق</p>
            
            <ul style="text-align:inherit; list-style:none; padding:20px; background:var(--badge-bg); border-radius:16px; margin:20px 0;">
                <li style="margin-bottom:10px; display:flex; align-items:center; gap:10px; color:#d32f2f;">
                    <i class="fas fa-exclamation-triangle"></i> 
                    <span data-i18n="welcomeNote1"><b>تنبيه هام:</b> الحجز لا يتم إلا بعد دفع العربون.</span>
                </li>
                <li style="display:flex; align-items:center; gap:10px;">
                    <i class="fas fa-credit-card" style="color:var(--primary-gold)"></i> 
                    <span data-i18n="welcomeNote2"><b>الدفع:</b> العربون عبر Qi Card (الماستر) حصراً.</span>
                </li>
            </ul>

            <button class="book-btn" style="width:100%" onclick="acceptTerms()" data-i18n="agreeBtn">موافق، ابدأ التصفح</button>
        </div>
    </div>

    <header>
        <span class="brand-badge" data-i18n="badgePremium">Premium Rentals</span>
        <div class="header-btns">
            <div class="icon-btn" onclick="openLangModal()"><i class="fas fa-globe"></i></div>
            <div class="icon-btn" onclick="toggleTheme()"><i id="theme-icon" class="fas fa-moon"></i></div>
            <div class="icon-btn settings-btn" onclick="openSettingsModal()"><i class="fas fa-cog"></i></div>
        </div>
        <h1>Dream Farm</h1>
        <p style="color:rgba(255,255,255,0.8);" data-i18n="headerDesc">تجربة استثنائية لأجمل المزارع السياحية</p>
    </header>

    <div class="search-container">
        <div class="search-box-wrapper">
            <div class="search-input-group">
                <i class="fas fa-search" style="color:var(--primary-gold)"></i>
                <input type="text" id="searchInput" placeholder="ابحث عن مزرعة..." data-i18n-placeholder="searchPlaceholder">
            </div>
            <div class="date-input-group">
                <i class="far fa-calendar-alt"></i>
                <input type="text" id="searchDate" placeholder="التاريخ" data-i18n-placeholder="datePlaceholder" readonly>
                <i class="fas fa-times-circle clear-date" id="clearDateBtn" onclick="clearSearchDate(event)"></i>
            </div>
        </div>
        
        <div class="filter-scroll">
            <button class="filter-btn active" onclick="filterFarms('all', this)"><i class="fas fa-th"></i> <span data-i18n="filterAll">الكل</span></button>
            <button class="filter-btn" onclick="filterFarms('favorites', this)"><i class="fas fa-heart" style="color:#e91e63"></i> <span data-i18n="filterFav">المفضلة</span></button>
            <button class="filter-btn" onclick="filterFarms('family', this)"><i class="fas fa-users"></i> <span data-i18n="filterFam">عائلات</span></button>
            <button class="filter-btn" onclick="filterFarms('pool', this)"><i class="fas fa-swimming-pool"></i> <span data-i18n="filterPool">مسبح</span></button>
            <button class="filter-btn" onclick="filterFarms('youth', this)"><i class="fas fa-user-friends"></i> <span data-i18n="filterYouth">شباب</span></button>
            <button class="filter-btn" onclick="filterFarms('economy', this)"><i class="fas fa-tag"></i> <span data-i18n="filterEco">اقتصادي</span></button>
        </div>
    </div>

    <div class="container" id="farm-list-container"></div>
    
    <div class="social-dock">
        <a href="#" class="social-bubble fb"><i class="fab fa-facebook-f"></i></a>
        <a href="#" class="social-bubble in"><i class="fab fa-instagram"></i></a>
        <a href="https://www.tiktok.com/@dream.farm68" class="social-bubble tk"><i class="fab fa-tiktok"></i></a>
    </div>
    <button id="scrollTopBtn" onclick="scrollToTop()"><i class="fas fa-arrow-up"></i></button>

    <footer>
        <span class="footer-logo">Dream Farm</span>
        <p style="font-size:0.9rem; color:rgba(255,255,255,0.7);" data-i18n="footerDesc">أفضل خيار لقضاء عطلة مميزة</p>
        <div class="footer-links">
            <a href="#" onclick="scrollToTop()" data-i18n="footerHome">الرئيسية</a>
            <a href="#" onclick="filterFarms('favorites', document.querySelectorAll('.filter-btn')[1])" data-i18n="filterFav">المفضلة</a>
            <a href="#" onclick="openSettingsModal()" data-i18n="footerPolicy">سياسة الحجز</a>
        </div>
        <div style="font-size:0.8rem; opacity:0.4; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px; margin-top:20px;">
            &copy; 2025 Dream Farm. All rights reserved.
        </div>
    </footer>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal-box">
            <span class="close-modal" onclick="closeSettingsModal()">&times;</span>
            <h3 style="text-align:center; margin-bottom:25px;" data-i18n="settingsTitle">الإعدادات والمساعدة</h3>
            
            <div style="background:rgba(37, 211, 102, 0.1); border:2px dashed #25D366; padding:25px; border-radius:16px; text-align:center; margin-bottom:30px;">
                <h4 style="margin-bottom:8px;" data-i18n="ownerTitle">هل تملك مزرعة؟</h4>
                <p style="font-size:0.85rem; color:var(--text-sec); margin-bottom:15px;" data-i18n="ownerDesc">انضم إلينا واعرض مزرعتك للإيجار الآن</p>
                <a href="https://wa.me/9647502679528?text=السلام%20عليكم%20اريد%20اضافة%20مزرعتي" target="_blank" style="background:#25D366; color:white; padding:10px 25px; border-radius:30px; text-decoration:none; font-weight:bold; display:inline-block;" data-i18n="contactAdmin">تواصل مع الإدارة</a>
            </div>

            <h5 style="margin-bottom:15px; border-bottom:1px solid var(--border-color); padding-bottom:10px;" data-i18n="rulesTitle">تعليمات هامة</h5>
            <ul style="list-style:none; padding:0; text-align:inherit; color:var(--text-sec); line-height:1.8; font-size:0.95rem;">
                <li style="margin-bottom:10px; color:#d32f2f; font-weight:bold;">
                    <i class="fas fa-exclamation-triangle" style="margin-inline-end:8px;"></i> <span data-i18n="rule1">لا يتم حجز المزرعة إلا بعد استلام العربون.</span>
                </li>
                <li style="margin-bottom:10px;">
                    <i class="fas fa-credit-card" style="color:var(--primary-gold); margin-inline-end:8px;"></i> <span data-i18n="rule2">الدفع عن طريق Qi Card (الماستر).</span>
                </li>
                <li>
                    <i class="fas fa-clock" style="color:var(--primary-gold); margin-inline-end:8px;"></i> <span data-i18n="rule3">وقت الدخول: 1:00 ظهراً / الخروج: 11:00 صباحاً</span>
                </li>
            </ul>
        </div>
    </div>

    <div id="booking-modal" class="modal-overlay">
        <div class="modal-box">
            <span class="close-modal" onclick="closeModal()"><i class="fas fa-times"></i></span>
            <h3 style="text-align:center; margin-bottom:5px;" data-i18n="bookingTitle">طلب حجز</h3>
            <p style="text-align:center;color:var(--text-sec);font-size:0.9rem;margin-bottom:20px;"><span data-i18n="for">لـ</span> <span id="modal-farm-name" style="color:var(--primary-gold);font-weight:bold;"></span></p>
            
            <form id="booking-form">
                <input type="hidden" id="farm-id-modal">
                <div class="form-group">
                    <label data-i18n="labelName">الاسم الثلاثي</label>
                    <input type="text" id="name" required placeholder="" data-i18n-placeholder="phName">
                </div>
                
                <div class="form-group">
                    <label data-i18n="labelDate">تاريخ الحجز</label>
                    <input type="text" id="date" required placeholder="" data-i18n-placeholder="phDate" style="cursor:pointer;">
                </div>

                <div id="price-calc-area" style="text-align:center; padding:15px; background:var(--badge-bg); border:1px solid var(--border-color); border-radius:12px; margin-bottom:20px; display:none;"></div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div class="form-group">
                        <label data-i18n="labelGuests">العدد الكلي</label>
                        <input type="number" id="guests" placeholder="10" required min="1">
                    </div>
                    <div class="form-group">
                        <label data-i18n="labelFamilies">عدد العوائل</label>
                        <input type="number" id="families" placeholder="2" min="1">
                    </div>
                </div>

                <div class="form-group">
                    <label data-i18n="labelType">نوع الكروب</label>
                    <select id="type" required></select>
                </div>
                <button type="submit" id="submit-btn" class="submit-wa"><i class="fab fa-whatsapp" style="font-size:1.2rem;"></i> <span data-i18n="btnWhatsapp">إرسال الطلب واتساب</span></button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/ar.js"></script>

    <script>
        // --- TRANSLATION DATA ---
        const translations = {
            ar: {
                pageTitle: "Dream Farm | باشترین مزارع بۆ بەکرێگرتن",
                badgePremium: "Premium Rentals",
                headerDesc: "تجربة استثنائية لأجمل المزارع السياحية",
                searchPlaceholder: "ابحث عن مزرعة...",
                datePlaceholder: "التاريخ",
                filterAll: "الكل",
                filterFav: "المفضلة",
                filterFam: "عائلات",
                filterPool: "مسبح",
                filterYouth: "شباب",
                filterEco: "اقتصادي",
                footerDesc: "أفضل خيار لقضاء عطلة مميزة",
                footerHome: "الرئيسية",
                footerPolicy: "سياسة الحجز",
                copySuccess: "<i class='fas fa-check-circle'></i> تم نسخ الرابط بنجاح",
                welcomeTitle: "أهلاً بك في Dream Farm",
                welcomeSub: "الوجهة الأولى للمزارع الراقية في العراق",
                welcomeNote1: "<b>تنبيه هام:</b> الحجز لا يتم إلا بعد دفع العربون.",
                welcomeNote2: "<b>الدفع:</b> العربون عبر Qi Card (الماستر) حصراً.",
                agreeBtn: "موافق، ابدأ التصفح",
                settingsTitle: "الإعدادات والمساعدة",
                ownerTitle: "هل تملك مزرعة؟",
                ownerDesc: "انضم إلينا واعرض مزرعتك للإيجار الآن",
                contactAdmin: "تواصل مع الإدارة",
                rulesTitle: "تعليمات هامة",
                rule1: "لا يتم حجز المزرعة إلا بعد استلام العربون.",
                rule2: "الدفع عن طريق Qi Card (الماستر).",
                rule3: "وقت الدخول: 1:00 ظهراً / الخروج: 11:00 صباحاً",
                bookingTitle: "طلب حجز",
                for: "لـ",
                labelName: "الاسم الثلاثي",
                phName: "مثال: أحمد محمد علي",
                labelDate: "تاريخ الحجز",
                phDate: "اختر التاريخ...",
                labelGuests: "العدد الكلي",
                labelFamilies: "عدد العوائل",
                labelType: "نوع الكروب",
                btnWhatsapp: "إرسال الطلب واتساب",
                viewers: "أشخاص يشاهدون الآن",
                bookNow: "احجز الآن",
                curr: "د.ع",
                selectLang: "اختر اللغة",
                typeFam: "عائلات",
                typeYouth: "شباب",
                typeMix: "مختلط",
                optFam: "عائلات فقط",
                optYouth: "شباب",
                optAll: "عائلات / شباب",
                priceExpected: "السعر المتوقع",
                priceBooked: "عذراً، محجوز",
                features: {
                    pool: "مسبح مدفأ", cinema: "سينما خارجية", gen: "مولدة 24h",
                    view: "إطلالة بانوراما", bbq: "ساحة شواء", fire: "موقد حطب",
                    wood: "تصميم خشبي", priv: "خصوصية تامة", river: "نهر قريب"
                }
            },
            ku: {
                pageTitle: "Dream Farm | باشترین مەزرەعە بۆ کرێ",
                badgePremium: "کرێکرنا راقی",
                headerDesc: "خۆشترین مەزرەعە و ڤێلا ل دهۆکێ و دەوروبەر",
                searchPlaceholder: "لێگەریان بۆ مەزرەعێ...",
                datePlaceholder: "بەروار",
                filterAll: "هەمی",
                filterFav: "دڵخواز",
                filterFam: "خێزان",
                filterPool: "مەسبەح",
                filterYouth: "گەنج",
                filterEco: "ئابووری",
                footerDesc: "باشترین هەڵبژاردن بۆ بێهنڤەدانەکا تایبەت",
                footerHome: "سەرەکی",
                footerPolicy: "رێنمایێن حجزکرنێ",
                copySuccess: "<i class='fas fa-check-circle'></i> لینک هاتە کۆپیکرن",
                welcomeTitle: "بخێرهاتی بۆ Dream Farm",
                welcomeSub: "باشترین شوێن بۆ گەریانێ ل عیراقێ",
                welcomeNote1: "<b>ئگەهداریا گرنگ:</b> حجزکرن بێ عەربون ناهێتە تەمامکرن.",
                welcomeNote2: "<b>پارەدان:</b> عەربون تەنێ ب رێکا Qi Card (ماستەر).",
                agreeBtn: "باشە، دەستپێ بکە",
                settingsTitle: "رێکخستن و هاریکاری",
                ownerTitle: "تۆ خودان مەزرەعەی؟",
                ownerDesc: "مەزرەعا خۆ زێدە بکە و بدە کرێ",
                contactAdmin: "پەیوەندی ب ئیدارێ بکە",
                rulesTitle: "رێنمایێن گرنگ",
                rule1: "مەزرەعە ناهێتە حجزکرن هەتا عەربون نەهێتە دان.",
                rule2: "پارەدان ب رێکا Qi Card (ماستەر) یە.",
                rule3: "دەمێ هاتنە ژوور: ١:٠٠ نیڤرۆ / دەرکەڤتن: ١١:٠٠ سپێدێ",
                bookingTitle: "داخوازیا حجزکرنێ",
                for: "بۆ",
                labelName: "ناڤێ سیانی",
                phName: "نموونە: ئەحمەد محەمەد عەلی",
                labelDate: "بەروارێ حجزێ",
                phDate: "بەرواری هەڵبژێرە...",
                labelGuests: "هەژمارا گشتی",
                labelFamilies: "هەژمارا خێزانا",
                labelType: "جورێ گروپی",
                btnWhatsapp: "داخوازیێ ب واتسئەپ فرێکە",
                viewers: "کەس نوکە د سەحکەنێ",
                bookNow: "نوکە حیجزکە",
                curr: "د.ع",
                selectLang: "زمانێ هەڵبژێرە",
                typeFam: "خێزان",
                typeYouth: "گەنج",
                typeMix: "تێکەڵ",
                optFam: "تەنێ خێزان",
                optYouth: "گەنج",
                optAll: "خێزان / گەنج",
                priceExpected: "بهایێ پێشبینیکری",
                priceBooked: "ببورە، یا گیرايە",
                features: {
                    pool: "مەسبەحا گەرم", cinema: "سینەما دەرەکی", gen: "موەلیدە 24h",
                    view: "مەنزەرێ پانۆراما", bbq: "جهێ باربیکیۆ", fire: "ئاگری دار",
                    wood: "دیزاینێ تەختە", priv: "تایبەتمەندی تەمام", river: "نێزیکی ڕووباری"
                }
            },
            en: {
                pageTitle: "Dream Farm | Best Farms for Rent",
                badgePremium: "Premium Rentals",
                headerDesc: "Exceptional experience for the best tourist farms",
                searchPlaceholder: "Search for a farm...",
                datePlaceholder: "Date",
                filterAll: "All",
                filterFav: "Favorites",
                filterFam: "Family",
                filterPool: "Pool",
                filterYouth: "Youth",
                filterEco: "Economy",
                footerDesc: "The best choice for a special holiday",
                footerHome: "Home",
                footerPolicy: "Booking Policy",
                copySuccess: "<i class='fas fa-check-circle'></i> Link copied successfully",
                welcomeTitle: "Welcome to Dream Farm",
                welcomeSub: "The premier destination for luxury farms in Iraq",
                welcomeNote1: "<b>Important:</b> Booking is confirmed only after deposit.",
                welcomeNote2: "<b>Payment:</b> Deposit via Qi Card (Mastercard) only.",
                agreeBtn: "Agree, Start Browsing",
                settingsTitle: "Settings & Help",
                ownerTitle: "Own a Farm?",
                ownerDesc: "Join us and list your farm for rent now",
                contactAdmin: "Contact Admin",
                rulesTitle: "Important Rules",
                rule1: "Farm is not booked without deposit.",
                rule2: "Payment via Qi Card (Mastercard).",
                rule3: "Check-in: 1:00 PM / Check-out: 11:00 AM",
                bookingTitle: "Booking Request",
                for: "For",
                labelName: "Full Name",
                phName: "Ex: Ahmed Mohammed Ali",
                labelDate: "Booking Date",
                phDate: "Select date...",
                labelGuests: "Total Guests",
                labelFamilies: "Number of Families",
                labelType: "Group Type",
                btnWhatsapp: "Send Request via WhatsApp",
                viewers: "people viewing now",
                bookNow: "Book Now",
                curr: "IQD",
                selectLang: "Select Language",
                typeFam: "Families",
                typeYouth: "Youth",
                typeMix: "Mixed",
                optFam: "Families Only",
                optYouth: "Youth",
                optAll: "Families / Youth",
                priceExpected: "Expected Price",
                priceBooked: "Sorry, Booked",
                features: {
                    pool: "Heated Pool", cinema: "Outdoor Cinema", gen: "Generator 24h",
                    view: "Panoramic View", bbq: "BBQ Area", fire: "Fireplace",
                    wood: "Wooden Design", priv: "Full Privacy", river: "Near River"
                }
            }
        };

        const farmsData = [
            { id: 1, name: { ar: "(1)", ku: "(1)", en: "(1)" }, location: { ar: "أشوا - سرسنك", ku: "ئاشەوا - سەرسنک", en: "Ashawa - Sarsink" }, isVerified: true, images: ["dream.jpg", "jjj.jpg"], featureKeys: ["pool", "cinema", "gen"], bookedDates: ["2025-12-25", "2025-12-28"], allowedType: "family", rawPrice: 150000, pricing: { default: "150,000", special: { 4: "200,000", 5: "250,000", 6: "175,000" } } },
            { id: 2, name: { ar: "فيلا الجبل", ku: "ڤێلا چیا", en: "Mountain Villa" }, location: { ar: "جبل ازمر", ku: "چیایێ ئەزمەر", en: "Azmar Mountain" }, isVerified: false, images: ["https://images.unsplash.com/photo-1518780664697-55e3ad937233?w=600&q=80"], featureKeys: ["view", "bbq", "fire"], bookedDates: ["2025-06-20"], allowedType: "all", rawPrice: 75000, pricing: { default: "75,000", special: { 4: "100,000", 5: "125,000", 6: "90,000" } } },
            { id: 3, name: { ar: "كوخ الغابة", ku: "کوخێ دارستانێ", en: "Forest Cabin" }, location: { ar: "شارباژير", ku: "شارباژێڕ", en: "Sharbazher" }, isVerified: true, images: ["https://images.unsplash.com/photo-1542718610-a1d656d1884c?w=600&q=80"], featureKeys: ["wood", "priv", "river"], bookedDates: ["2025-12-19", "2026-01-05"], allowedType: "youth", rawPrice: 50000, pricing: { default: "50,000", special: { 4: "65,000", 5: "80,000", 6: "60,000" } } },
            { id: 4, name: { ar: "مزرعة القصر الذهبي", ku: "مەزرەعا قەسرا زێڕین", en: "Golden Palace Farm" }, location: { ar: "دوكان، قرب السد", ku: "دوکان، نێزیک بەنداڤێ", en: "Dukan, Near Dam" }, isVerified: true, images: ["dream.jpg", "https://images.unsplash.com/photo-1566073771259-6a8506099945?w=600&q=80"], featureKeys: ["pool", "cinema", "gen"], bookedDates: ["2025-12-25"], allowedType: "family", rawPrice: 150000, pricing: { default: "150,000", special: { 4: "200,000", 5: "250,000", 6: "175,000" } } }
        ];

        let currentLang = localStorage.getItem('dreamFarm_lang') || 'ar';
        let currentCategory = 'all';
        let currentSearch = '';
        let currentSearchDate = '';
        let swiperInstances = [];
        let favorites = JSON.parse(localStorage.getItem('dreamFarm_favs')) || []; 

        // Theme Init
        const storedTheme = localStorage.getItem('dreamFarm_theme') || 'light';
        if(storedTheme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.getElementById('theme-icon').classList.replace('fa-moon', 'fa-sun');
        }

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('dreamFarm_lang', lang);
            
            // Set Direction
            if (lang === 'en') document.documentElement.setAttribute('dir', 'ltr');
            else document.documentElement.setAttribute('dir', 'rtl');
            document.documentElement.setAttribute('lang', lang);

            // Update Text
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(translations[lang][key]) el.innerHTML = translations[lang][key];
            });

            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if(translations[lang][key]) el.placeholder = translations[lang][key];
            });

            // UI Updates
            document.querySelectorAll('.lang-option i').forEach(i => i.style.display = 'none');
            document.querySelectorAll('.lang-option').forEach(o => o.classList.remove('selected'));
            document.getElementById(`check-${lang}`).style.display = 'block';
            document.getElementById(`check-${lang}`).parentElement.classList.add('selected');

            renderFarms(farmsData);
            applyFilters();
            closeLangModal();
        }

        function getFeatureStyle(key) {
            if(key === 'pool') return { icon: 'fa-swimming-pool', color: '#0288d1' };
            if(key === 'cinema') return { icon: 'fa-film', color: '#e53935' };
            if(key === 'gen') return { icon: 'fa-bolt', color: '#fbc02d' };
            if(key === 'bbq') return { icon: 'fa-fire', color: '#d84315' };
            if(key === 'fire') return { icon: 'fa-fire-alt', color: '#ff7043' };
            if(key === 'wood') return { icon: 'fa-tree', color: '#2e7d32' };
            if(key === 'river') return { icon: 'fa-water', color: '#0277bd' };
            if(key === 'view') return { icon: 'fa-mountain', color: '#5d4037' };
            if(key === 'priv') return { icon: 'fa-user-shield', color: '#4527a0' };
            return { icon: 'fa-check', color: '#555' };
        }

        function getSmartViewers(id) {
            const now = Date.now();
            const storageKey = `viewers_smart_${id}`;
            const stored = JSON.parse(localStorage.getItem(storageKey));
            if (stored && now < stored.expiry) return stored.count;
            let newCount = Math.floor(Math.random() * 20) + 1;
            const duration = (Math.floor(Math.random() * 30) + 15) * 1000; 
            localStorage.setItem(storageKey, JSON.stringify({ count: newCount, expiry: now + duration }));
            return newCount;
        }

        window.addEventListener('load', () => { 
            setLanguage(currentLang);
            setTimeout(() => { 
                document.getElementById('loader').style.display = 'none';
                document.getElementById('welcome-modal').style.opacity = '1';
                document.getElementById('welcome-modal').style.pointerEvents = 'all';
            }, 1000);
            
            checkURLParams(); 
            
            flatpickr("#searchDate", {
                locale: currentLang === 'en' ? "en" : "ar",
                minDate: "today",
                dateFormat: "Y-m-d",
                onChange: function(selectedDates, dateStr) {
                    currentSearchDate = dateStr;
                    document.getElementById('clearDateBtn').style.display = 'block';
                    applyFilters();
                }
            });
        });

        const container = document.getElementById('farm-list-container');
        function renderFarms(list) {
            swiperInstances.forEach(s => s.destroy(true, true));
            swiperInstances = [];
            container.innerHTML = "";
            const T = translations[currentLang];

            if (list.length === 0) { 
                container.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:50px;"><h3>${T.priceBooked.replace('عذراً، محجوز', 'No Results')}</h3><button class="filter-btn active" style="margin-top:10px; display:inline-block" onclick="resetFilters()">${T.filterAll}</button></div>`; 
                return; 
            }

            list.forEach((farm) => {
                let badgeText = '', badgeClass = '';
                if(farm.allowedType === 'family') { badgeClass = '#E91E63'; badgeText = T.typeFam; }
                else if(farm.allowedType === 'youth') { badgeClass = '#9C27B0'; badgeText = T.typeYouth; }
                else { badgeClass = '#009688'; badgeText = T.typeMix; }

                const badge = `<span style="background:${badgeClass};color:white;padding:4px 12px;border-radius:20px;font-size:0.75rem;font-weight:bold; margin-inline-end:auto;">${badgeText}</span>`;
                const verifiedIcon = farm.isVerified ? '<i class="fas fa-check-circle verified-badge"></i>' : '';
                const isFav = favorites.includes(farm.id) ? 'is-fav' : '';
                const heartIcon = favorites.includes(farm.id) ? 'fas fa-heart' : 'far fa-heart';
                const viewers = getSmartViewers(farm.id); 

                const slides = farm.images.map((img, idx) => 
                    `<div class="swiper-slide">
                        <img src="${img}" loading="lazy">
                        <div class="expand-btn" onclick="openLightbox(${farm.id}, ${idx})"><i class="fas fa-expand"></i></div>
                    </div>`
                ).join('');

                const amenitiesHTML = farm.featureKeys.map(key => {
                    const style = getFeatureStyle(key);
                    return `<div class="amenity-chip"><i class="fas ${style.icon} amenity-icon" style="color:${style.color}"></i> ${T.features[key] || key}</div>`;
                }).join('');

                const fName = farm.name[currentLang] || farm.name.ar;
                const fLoc = farm.location[currentLang] || farm.location.ar;

                container.innerHTML += `
                <div class="farm-card is-visible" id="farm-${farm.id}">
                    <div class="img-actions">
                        <div class="action-icon ${isFav}" onclick="toggleFav(${farm.id}, this)"><i class="${heartIcon}"></i></div>
                        <div class="action-icon" onclick="shareFarm(${farm.id})"><i class="fas fa-share-alt"></i></div>
                    </div>
                    <div class="swiper mySwiper-${farm.id}"><div class="swiper-wrapper">${slides}</div><div class="swiper-pagination"></div></div>
                    <div class="card-content">
                        <div class="card-title-row">
                            <h3>${fName} ${verifiedIcon}</h3>
                            ${badge}
                        </div>
                        <div class="urgency-badge"><i class="fas fa-eye"></i> ${viewers} ${T.viewers}</div>
                        <div class="location-text"><i class="fas fa-map-marker-alt" style="color:var(--primary-gold)"></i> ${fLoc}</div>
                        <div class="amenities-list">${amenitiesHTML}</div>
                        <div class="price-wrapper">
                            <div><div class="price-val">${farm.pricing.default} <small style="font-size:0.8rem;font-weight:400">${T.curr}</small></div></div>
                            <button class="book-btn" onclick="openModal(${farm.id})">${T.bookNow}</button>
                        </div>
                    </div>
                </div>`;
            });

            list.forEach(farm => {
                swiperInstances.push(new Swiper(`.mySwiper-${farm.id}`, { pagination: { el: ".swiper-pagination", dynamicBullets: true }, loop: true }));
            });
        }

        // --- Core Functions ---
        window.openLangModal = () => document.getElementById('lang-modal').classList.add('modal-active');
        window.closeLangModal = () => document.getElementById('lang-modal').classList.remove('modal-active');
        window.openSettingsModal = () => document.getElementById('settings-modal').classList.add('modal-active');
        window.closeSettingsModal = () => document.getElementById('settings-modal').classList.remove('modal-active');
        window.acceptTerms = () => { document.getElementById('welcome-modal').style.opacity = '0'; document.getElementById('welcome-modal').style.pointerEvents = 'none'; }

        window.toggleTheme = () => {
            const html = document.documentElement;
            if (html.getAttribute('data-theme') === 'dark') {
                html.removeAttribute('data-theme'); localStorage.setItem('dreamFarm_theme', 'light');
                document.getElementById('theme-icon').classList.replace('fa-sun', 'fa-moon');
            } else {
                html.setAttribute('data-theme', 'dark'); localStorage.setItem('dreamFarm_theme', 'dark');
                document.getElementById('theme-icon').classList.replace('fa-moon', 'fa-sun');
            }
        }

        window.filterFarms = (category, btnElement) => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
            currentCategory = category;
            applyFilters();
        };

        window.clearSearchDate = (e) => {
            e.stopPropagation(); currentSearchDate = '';
            document.getElementById('searchDate').value = ''; 
            document.getElementById('clearDateBtn').style.display = 'none';
            applyFilters();
        }

        window.resetFilters = () => {
            document.getElementById('searchInput').value = ''; currentSearch = ''; currentCategory = 'all';
            clearSearchDate({stopPropagation:()=>{}}); 
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.filter-btn').classList.add('active');
            applyFilters();
        }

        document.getElementById('searchInput').addEventListener('keyup', (e) => {
            currentSearch = e.target.value.toLowerCase();
            applyFilters();
        });

        function applyFilters() {
            const filtered = farmsData.filter(farm => {
                const n = farm.name; const l = farm.location;
                const searchTxt = currentSearch;
                const matchesSearch = n.ar.includes(searchTxt) || n.ku.includes(searchTxt) || n.en.toLowerCase().includes(searchTxt) || l.ar.includes(searchTxt) || l.ku.includes(searchTxt) || l.en.toLowerCase().includes(searchTxt);
                
                let matchesCategory = true;
                if (currentCategory === 'favorites') matchesCategory = favorites.includes(farm.id);
                else if (currentCategory === 'family') matchesCategory = (farm.allowedType === 'family' || farm.allowedType === 'all');
                else if (currentCategory === 'youth') matchesCategory = (farm.allowedType === 'youth' || farm.allowedType === 'all');
                else if (currentCategory === 'pool') matchesCategory = farm.featureKeys.includes('pool');
                else if (currentCategory === 'economy') matchesCategory = farm.rawPrice <= 100000;
                
                let matchesDate = true;
                if(currentSearchDate) matchesDate = !farm.bookedDates.includes(currentSearchDate);
                
                return matchesSearch && matchesCategory && matchesDate;
            });
            renderFarms(filtered);
        }

        window.toggleFav = (id, btn) => {
            if(favorites.includes(id)) {
                favorites = favorites.filter(fid => fid !== id);
                btn.classList.remove('is-fav'); btn.innerHTML = '<i class="far fa-heart"></i>';
            } else {
                favorites.push(id);
                btn.classList.add('is-fav'); btn.innerHTML = '<i class="fas fa-heart"></i>';
            }
            localStorage.setItem('dreamFarm_favs', JSON.stringify(favorites));
            if(currentCategory === 'favorites') applyFilters();
        }

        window.shareFarm = async (id) => {
            const farm = farmsData.find(f => f.id === id);
            const T = translations[currentLang];
            const name = farm.name[currentLang] || farm.name.ar;
            const shareData = { title: name, text: `${name} - ${T.headerDesc}`, url: window.location.origin + window.location.pathname + '?id=' + id };
            if (navigator.share) { try { await navigator.share(shareData); } catch (err) {} } 
            else {
                navigator.clipboard.writeText(shareData.url).then(() => {
                    const t = document.getElementById('toast-box'); t.classList.add('show');
                    setTimeout(() => t.classList.remove('show'), 3000);
                });
            }
        }

        const modal = document.getElementById('booking-modal');
        const dateInput = document.getElementById('date');
        const priceArea = document.getElementById('price-calc-area');
        const submitBtn = document.getElementById('submit-btn');
        let currentFarm = null, fpInstance = null;

        window.openModal = (id) => {
            const T = translations[currentLang];
            currentFarm = farmsData.find(f => f.id === id);
            document.getElementById('modal-farm-name').textContent = currentFarm.name[currentLang] || currentFarm.name.ar;
            document.getElementById('farm-id-modal').value = id;
            
            if(fpInstance) fpInstance.destroy();
            fpInstance = flatpickr("#date", {
                locale: currentLang === 'en' ? "en" : "ar",
                minDate: "today", dateFormat: "Y-m-d", disable: currentFarm.bookedDates,
                onChange: function(selectedDates, dateStr, instance) { checkPrice(); }
            });

            dateInput.value = ''; priceArea.style.display = 'none'; submitBtn.disabled = true; submitBtn.style.opacity = '0.6';
            document.getElementById('guests').value = ''; document.getElementById('families').value = '';
            
            const typeSel = document.getElementById('type'); typeSel.innerHTML = '';
            const opts = { family: `<option>${T.optFam}</option>`, youth: `<option>${T.optYouth}</option>`, all: `<option>${T.optAll}</option>` };
            typeSel.innerHTML = opts[currentFarm.allowedType] || opts.all;
            modal.classList.add('modal-active');
        }
        window.closeModal = () => { modal.classList.remove('modal-active'); }

        window.checkPrice = () => {
            const T = translations[currentLang];
            if(!dateInput.value || !currentFarm) return;
            const dStr = dateInput.value;
            const day = new Date(dStr.split('-')[0], dStr.split('-')[1]-1, dStr.split('-')[2]).getDay();

            let price = currentFarm.pricing.default; 
            if(currentFarm.pricing.special && currentFarm.pricing.special[day]) price = currentFarm.pricing.special[day];
            
            priceArea.style.display = 'block'; 
            priceArea.innerHTML = `<div style="font-size:0.9rem;color:var(--text-sec);">${T.priceExpected}</div><div style="color:var(--primary-gold);font-weight:800;font-size:1.4rem;">${price} <small>${T.curr}</small></div>`; 
            submitBtn.disabled = false; submitBtn.style.opacity = '1';
        }

        document.getElementById('booking-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const securedFarm = farmsData.find(f => f.id === parseInt(document.getElementById('farm-id-modal').value)); 
            const n = document.getElementById('name').value; const d = dateInput.value;
            const g = document.getElementById('guests').value; const t = document.getElementById('type').value;
            const msg = `*🔔 طلب حجز جديد (${currentLang.toUpperCase()})*\n🏡 ${securedFarm.name.ar}\n📅 ${d}\n👤 الاسم: ${n}\n👥 العدد: ${g}\n📋 النوع: ${t}`;
            window.open(`https://wa.me/9647502679528?text=${encodeURIComponent(msg)}`, '_blank');
            closeModal();
        });

        let currentLbImages = [], currentLbIndex = 0;
        window.openLightbox = (farmId, index) => {
            const farm = farmsData.find(f => f.id === farmId);
            currentLbImages = farm.images; currentLbIndex = index;
            updateLb(); document.getElementById('lightbox').classList.add('lightbox-active');
        }
        window.closeLightbox = () => { document.getElementById('lightbox').classList.remove('lightbox-active'); }
        window.changeImage = (dir) => {
            currentLbIndex = (currentLbIndex + dir + currentLbImages.length) % currentLbImages.length;
            updateLb();
        }
        function updateLb() {
            document.getElementById('lb-image').src = currentLbImages[currentLbIndex];
            document.getElementById('lb-counter').innerText = `${currentLbIndex + 1} / ${currentLbImages.length}`;
        }
        
        function checkURLParams() {
            const params = new URLSearchParams(window.location.search);
            const farmId = params.get('id');
            if (farmId) { const farm = farmsData.find(f => f.id == farmId); if (farm) { acceptTerms(); openModal(farm.id); } }
        }
        
        window.scrollToTop = () => { window.scrollTo({top: 0, behavior: 'smooth'}); };
        window.onscroll = () => { document.getElementById("scrollTopBtn").style.display = (window.scrollY > 300) ? "flex" : "none"; };
    </script>
</body>
</html>
